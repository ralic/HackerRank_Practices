<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>24.&nbsp;Authorization Architecture</title><link rel="stylesheet" type="text/css" href="css/manual-multipage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Spring Security Reference"><link rel="up" href="authorization.html" title="Part&nbsp;V.&nbsp;Authorization"><link rel="prev" href="authorization.html" title="Part&nbsp;V.&nbsp;Authorization"><link rel="next" href="secure-object-impls.html" title="25.&nbsp;Secure Object Implementations"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">24.&nbsp;Authorization Architecture</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="authorization.html">Prev</a>&nbsp;</td><th width="60%" align="center">Part&nbsp;V.&nbsp;Authorization</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="secure-object-impls.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="authz-arch" href="#authz-arch"></a>24.&nbsp;Authorization Architecture</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="authz-authorities" href="#authz-authorities"></a>24.1&nbsp;Authorities</h2></div></div></div>

<p>As we saw in the <a class="link" href="technical-overview.html#tech-granted-authority" title="9.2.3&nbsp;GrantedAuthority">technical overview</a>, all <code class="literal">Authentication</code> implementations store a list of <code class="literal">GrantedAuthority</code> objects. These represent the authorities that have been granted to the principal. the <code class="literal">GrantedAuthority</code> objects are inserted into the <code class="literal">Authentication</code> object by the <code class="literal">AuthenticationManager</code> and are later read by <code class="literal">AccessDecisionManager</code> s when making authorization decisions.</p>
<p><code class="literal">GrantedAuthority</code> is an interface with only one method:</p>
<pre class="programlisting">String getAuthority();</pre>
<p>This method allows
			<code class="literal">AccessDecisionManager</code> s to obtain a precise <code class="literal">String</code> representation of the <code class="literal">GrantedAuthority</code>. By returning a representation as a <code class="literal">String</code>, a <code class="literal">GrantedAuthority</code> can be easily "read" by most <code class="literal">AccessDecisionManager</code> s. If a <code class="literal">GrantedAuthority</code> cannot be precisely represented as a <code class="literal">String</code>, the <code class="literal">GrantedAuthority</code> is considered "complex" and <code class="literal">getAuthority()</code> must return <code class="literal">null</code>.</p>
<p>An example of a "complex" <code class="literal">GrantedAuthority</code> would be an implementation that stores a list of operations and authority thresholds that apply to different customer account numbers. Representing this complex <code class="literal">GrantedAuthority</code> as a <code class="literal">String</code> would be quite difficult, and as a result the <code class="literal">getAuthority()</code> method should return <code class="literal">null</code>. This will indicate to any <code class="literal">AccessDecisionManager</code> that it will need to specifically support the <code class="literal">GrantedAuthority</code> implementation in order to understand its contents.</p>
<p>Spring Security includes one concrete <code class="literal">GrantedAuthority</code> implementation, <code class="literal">SimpleGrantedAuthority</code>. This allows any user-specified <code class="literal">String</code> to be converted into a <code class="literal">GrantedAuthority</code>. All <code class="literal">AuthenticationProvider</code> s included with the security architecture use <code class="literal">SimpleGrantedAuthority</code> to populate the <code class="literal">Authentication</code> object.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="authz-pre-invocation" href="#authz-pre-invocation"></a>24.2&nbsp;Pre-Invocation Handling</h2></div></div></div>

<p>As we&#8217;ve also seen in the <a class="link" href="technical-overview.html#secure-objects" title="9.5.2&nbsp;Secure Objects and the AbstractSecurityInterceptor">Technical Overview</a> chapter, Spring Security provides interceptors which control access to secure objects such as method invocations or web requests. A pre-invocation decision on whether the invocation is allowed to proceed is made by the <code class="literal">AccessDecisionManager</code>.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="authz-access-decision-manager" href="#authz-access-decision-manager"></a>24.2.1&nbsp;The AccessDecisionManager</h3></div></div></div>

<p>The <code class="literal">AccessDecisionManager</code> is called by the <code class="literal">AbstractSecurityInterceptor</code> and is responsible for making final access control decisions. the <code class="literal">AccessDecisionManager</code> interface contains three methods:</p>
<pre class="programlisting"><span class="hl-keyword">void</span> decide(Authentication authentication, Object secureObject,
	Collection&lt;ConfigAttribute&gt; attrs) <span class="hl-keyword">throws</span> AccessDeniedException;

<span class="hl-keyword">boolean</span> supports(ConfigAttribute attribute);

<span class="hl-keyword">boolean</span> supports(Class clazz);</pre>
<p>The <code class="literal">AccessDecisionManager</code>'s <code class="literal">decide</code> method is passed all the relevant information it needs in order to make an authorization decision. In particular, passing the secure <code class="literal">Object</code> enables those arguments contained in the actual secure object invocation to be inspected. For example, let&#8217;s assume the secure object was a <code class="literal">MethodInvocation</code>. It would be easy to query the <code class="literal">MethodInvocation</code> for any <code class="literal">Customer</code> argument, and then implement some sort of security logic in the <code class="literal">AccessDecisionManager</code> to ensure the principal is permitted to operate on that customer. Implementations are expected to throw an <code class="literal">AccessDeniedException</code> if access is denied.</p>
<p>The <code class="literal">supports(ConfigAttribute)</code> method is called by the <code class="literal">AbstractSecurityInterceptor</code> at startup time to determine if the <code class="literal">AccessDecisionManager</code> can process the passed <code class="literal">ConfigAttribute</code>. The <code class="literal">supports(Class)</code> method is called by a security interceptor implementation to ensure the configured <code class="literal">AccessDecisionManager</code> supports the type of secure object that the security interceptor will present.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="authz-voting-based" href="#authz-voting-based"></a>24.2.2&nbsp;Voting-Based AccessDecisionManager Implementations</h3></div></div></div>

<p>Whilst users can implement their own <code class="literal">AccessDecisionManager</code> to control all aspects of authorization, Spring Security includes several <code class="literal">AccessDecisionManager</code> implementations that are based on voting. <a class="xref" href="authz-arch.html#authz-access-voting" title="Figure&nbsp;24.1.&nbsp;Voting Decision Manager">Figure&nbsp;24.1, &#8220;Voting Decision Manager&#8221;</a> illustrates the relevant classes.</p>
<div class="figure"><a name="authz-access-voting" href="#authz-access-voting"></a><p class="title"><b>Figure&nbsp;24.1.&nbsp;Voting Decision Manager</b></p><div class="figure-contents">

<div class="mediaobject"><img src="images/access-decision-voting.png" alt="access decision voting"></div>
</div></div><br class="figure-break">
<p>Using this approach, a series of <code class="literal">AccessDecisionVoter</code> implementations are polled on an authorization decision. The <code class="literal">AccessDecisionManager</code> then decides whether or not to throw an <code class="literal">AccessDeniedException</code> based on its assessment of the votes.</p>
<p>The <code class="literal">AccessDecisionVoter</code> interface has three methods:</p>
<pre class="programlisting"><span class="hl-keyword">int</span> vote(Authentication authentication, Object object, Collection&lt;ConfigAttribute&gt; attrs);

<span class="hl-keyword">boolean</span> supports(ConfigAttribute attribute);

<span class="hl-keyword">boolean</span> supports(Class clazz);</pre>
<p>Concrete implementations return an <code class="literal">int</code>, with possible values               being reflected in the <code class="literal">AccessDecisionVoter</code> static fields <code class="literal">ACCESS_ABSTAIN</code>, <code class="literal">ACCESS_DENIED</code> and <code class="literal">ACCESS_GRANTED</code>. A voting implementation will return <code class="literal">ACCESS_ABSTAIN</code> if it has no opinion on an authorization decision. If it does have an opinion, it must return either <code class="literal">ACCESS_DENIED</code> or <code class="literal">ACCESS_GRANTED</code>.</p>
<p>There are three concrete <code class="literal">AccessDecisionManager</code> s provided with Spring Security that tally the votes. The <code class="literal">ConsensusBased</code> implementation will grant or deny access based on the consensus of non-abstain votes. Properties are provided to control behavior in the event of an equality of votes or if all votes are abstain. The <code class="literal">AffirmativeBased</code> implementation will grant access if one or more <code class="literal">ACCESS_GRANTED</code> votes were received (i.e. a deny vote will be ignored, provided there was at least one grant vote). Like the <code class="literal">ConsensusBased</code> implementation, there is a parameter that controls the behavior if all voters abstain. The <code class="literal">UnanimousBased</code> provider expects unanimous <code class="literal">ACCESS_GRANTED</code> votes in order to grant access, ignoring abstains. It will deny access if there is any <code class="literal">ACCESS_DENIED</code> vote. Like the other implementations, there is a parameter that controls the behaviour if all voters abstain.</p>
<p>It is possible to implement a custom <code class="literal">AccessDecisionManager</code> that tallies votes differently. For example, votes from a particular <code class="literal">AccessDecisionVoter</code> might receive additional weighting, whilst a deny vote from a particular voter may have a veto effect.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="authz-role-voter" href="#authz-role-voter"></a>RoleVoter</h4></div></div></div>

<p>The most commonly used <code class="literal">AccessDecisionVoter</code> provided with Spring Security is the simple <code class="literal">RoleVoter</code>, which treats configuration attributes as simple role names and votes to grant access if the user has been assigned that role.</p>
<p>It will vote if any <code class="literal">ConfigAttribute</code> begins with the prefix <code class="literal">ROLE_</code>. It will vote to grant access if there is a <code class="literal">GrantedAuthority</code> which returns a <code class="literal">String</code> representation (via the <code class="literal">getAuthority()</code> method) exactly equal to one or more <code class="literal">ConfigAttributes</code> starting with the prefix <code class="literal">ROLE_</code>. If there is no exact match of any <code class="literal">ConfigAttribute</code> starting with <code class="literal">ROLE_</code>, the <code class="literal">RoleVoter</code> will vote to deny access. If no <code class="literal">ConfigAttribute</code> begins with <code class="literal">ROLE_</code>, the voter will abstain.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="authz-authenticated-voter" href="#authz-authenticated-voter"></a>AuthenticatedVoter</h4></div></div></div>

<p>Another voter which we&#8217;ve implicitly seen is the <code class="literal">AuthenticatedVoter</code>, which can be used to differentiate between anonymous, fully-authenticated and remember-me authenticated users. Many sites allow certain limited access under remember-me authentication, but require a user to confirm their identity by logging in for full access.</p>
<p>When we&#8217;ve used the attribute <code class="literal">IS_AUTHENTICATED_ANONYMOUSLY</code> to grant anonymous access, this attribute was being processed by the <code class="literal">AuthenticatedVoter</code>. See the Javadoc for this class for more information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="authz-custom-voter" href="#authz-custom-voter"></a>Custom Voters</h4></div></div></div>

<p>Obviously, you can also implement a custom <code class="literal">AccessDecisionVoter</code> and you can put just about any access-control logic you want in it. It might be specific to your application (business-logic related) or it might implement some security administration logic. For example, you&#8217;ll find a <a class="ulink" href="http://spring.io/blog/2009/01/03/spring-security-customization-part-2-adjusting-secured-session-in-real-time" target="_top">blog article</a> on the Spring web site which describes how to use a voter to deny access in real-time to users whose accounts have been suspended.</p>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="authz-after-invocation-handling" href="#authz-after-invocation-handling"></a>24.3&nbsp;After Invocation Handling</h2></div></div></div>

<p>Whilst the <code class="literal">AccessDecisionManager</code> is called by the <code class="literal">AbstractSecurityInterceptor</code> before proceeding with the secure object invocation, some applications need a way of modifying the object actually returned by the secure object invocation. Whilst you could easily implement your own AOP concern to achieve this, Spring Security provides a convenient hook that has several concrete implementations that integrate with its ACL capabilities.</p>
<p><a class="xref" href="authz-arch.html#authz-after-invocation" title="Figure&nbsp;24.2.&nbsp;After Invocation Implementation">Figure&nbsp;24.2, &#8220;After Invocation Implementation&#8221;</a> illustrates Spring Security&#8217;s <code class="literal">AfterInvocationManager</code> and its concrete implementations.</p>
<div class="figure"><a name="authz-after-invocation" href="#authz-after-invocation"></a><p class="title"><b>Figure&nbsp;24.2.&nbsp;After Invocation Implementation</b></p><div class="figure-contents">

<div class="mediaobject"><img src="images/after-invocation.png" alt="after invocation"></div>
</div></div><br class="figure-break">
<p>Like many other parts of Spring Security, <code class="literal">AfterInvocationManager</code> has a single concrete implementation, <code class="literal">AfterInvocationProviderManager</code>, which polls a list of <code class="literal">AfterInvocationProvider</code> s. Each <code class="literal">AfterInvocationProvider</code> is allowed to modify the return object or throw an <code class="literal">AccessDeniedException</code>. Indeed multiple providers can modify the object, as the result of the previous provider is passed to the next in the list.</p>
<p>Please be aware that if you&#8217;re using <code class="literal">AfterInvocationManager</code>, you will still need configuration attributes that allow the <code class="literal">MethodSecurityInterceptor</code>'s <code class="literal">AccessDecisionManager</code> to allow an operation. If you&#8217;re using the typical Spring Security included <code class="literal">AccessDecisionManager</code> implementations, having no configuration attributes defined for a particular secure method invocation will cause each <code class="literal">AccessDecisionVoter</code> to abstain from voting. In turn, if the <code class="literal">AccessDecisionManager</code> property           &#8220;allowIfAllAbstainDecisions&#8221; is <code class="literal">false</code>, an <code class="literal">AccessDeniedException</code> will be thrown. You may avoid this potential issue by either (i) setting &#8220;allowIfAllAbstainDecisions&#8221; to <code class="literal">true</code> (although this is generally not recommended) or (ii) simply ensure that there is at least one configuration attribute that an <code class="literal">AccessDecisionVoter</code> will vote to grant access for. This latter (recommended) approach is usually achieved through a <code class="literal">ROLE_USER</code> or <code class="literal">ROLE_AUTHENTICATED</code> configuration attribute.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="authz-hierarchical-roles" href="#authz-hierarchical-roles"></a>24.4&nbsp;Hierarchical Roles</h2></div></div></div>

<p>It is a common requirement that a particular role in an application should automatically "include" other roles. For example, in an application which has the concept of an "admin" and a "user" role, you may want an admin to be able to do everything a normal user can. To achieve this, you can either make sure that all admin users are also assigned the "user" role. Alternatively, you can modify every access constraint which requires the "user" role to also include the "admin" role. This can get quite complicated if you have a lot of different roles in your application.</p>
<p>The use of a role-hierarchy allows you to configure which roles (or authorities) should include others. An extended version of Spring Security&#8217;s <a class="link" href="authz-arch.html#authz-role-voter" title="RoleVoter">RoleVoter</a>, <code class="literal">RoleHierarchyVoter</code>, is configured with a <code class="literal">RoleHierarchy</code>, from which it obtains all the "reachable authorities" which the user is assigned. A typical configuration might look like this:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"roleVoter"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.access.vote.RoleHierarchyVoter"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"roleHierarchy"</span><span class="hl-tag"> /&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"roleHierarchy"</span>
		<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.access.hierarchicalroles.RoleHierarchyImpl"</span><span class="hl-tag">&gt;</span>
	<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"hierarchy"</span><span class="hl-tag">&gt;</span>
		<span class="hl-tag">&lt;value&gt;</span>
			ROLE_ADMIN &gt; ROLE_STAFF
			ROLE_STAFF &gt; ROLE_USER
			ROLE_USER &gt; ROLE_GUEST
		<span class="hl-tag">&lt;/value&gt;</span>
	<span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>Here we have four roles in a hierarchy <code class="literal">ROLE_ADMIN &#8658; ROLE_STAFF &#8658; ROLE_USER &#8658; ROLE_GUEST</code>. A user who is authenticated with <code class="literal">ROLE_ADMIN</code>, will behave as if they have all four roles when security constraints are evaluated against an <code class="literal">AccessDecisionManager</code> cconfigured with the above <code class="literal">RoleHierarchyVoter</code>. The <code class="literal">&gt;</code> symbol can be thought of as meaning "includes".</p>
<p>Role hierarchies offer a convenient means of simplifying the access-control configuration data for your application and/or reducing the number of authorities which you need to assign to a user. For more complex requirements you may wish to define a logical mapping between the specific access-rights your application requires and the roles that are assigned to users, translating between the two when loading the user information.</p>
</div>
</div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="authorization.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="authorization.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="secure-object-impls.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Part&nbsp;V.&nbsp;Authorization&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;25.&nbsp;Secure Object Implementations</td></tr></table></div></body></html>