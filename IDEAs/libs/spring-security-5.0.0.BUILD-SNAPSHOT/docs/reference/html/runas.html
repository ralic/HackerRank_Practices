<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>34.&nbsp;Run-As Authentication Replacement</title><link rel="stylesheet" type="text/css" href="css/manual-multipage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Spring Security Reference"><link rel="up" href="advanced-topics.html" title="Part&nbsp;VI.&nbsp;Additional Topics"><link rel="prev" href="x509.html" title="33.&nbsp;X.509 Authentication"><link rel="next" href="crypto.html" title="35.&nbsp;Spring Security Crypto Module"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">34.&nbsp;Run-As Authentication Replacement</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="x509.html">Prev</a>&nbsp;</td><th width="60%" align="center">Part&nbsp;VI.&nbsp;Additional Topics</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="crypto.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="runas" href="#runas"></a>34.&nbsp;Run-As Authentication Replacement</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="runas-overview" href="#runas-overview"></a>34.1&nbsp;Overview</h2></div></div></div>

<p>The <code class="literal">AbstractSecurityInterceptor</code> is able to temporarily replace the <code class="literal">Authentication</code> object in the <code class="literal">SecurityContext</code> and <code class="literal">SecurityContextHolder</code> during the secure object callback phase. This only occurs if the original <code class="literal">Authentication</code> object was successfully processed by the <code class="literal">AuthenticationManager</code> and <code class="literal">AccessDecisionManager</code>. The <code class="literal">RunAsManager</code> will indicate the replacement <code class="literal">Authentication</code> object, if any, that should be used during the <code class="literal">SecurityInterceptorCallback</code>.</p>
<p>By temporarily replacing the <code class="literal">Authentication</code> object during the secure object callback phase, the secured invocation will be able to call other objects which require different authentication and authorization credentials. It will also be able to perform any internal security checks for specific <code class="literal">GrantedAuthority</code> objects. Because Spring Security provides a number of helper classes that automatically configure remoting protocols based on the contents of the <code class="literal">SecurityContextHolder</code>, these run-as replacements are particularly useful when calling remote web services</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="runas-config" href="#runas-config"></a>34.2&nbsp;Configuration</h2></div></div></div>

<p>A <code class="literal">RunAsManager</code> interface is provided by Spring Security:</p>
<pre class="programlisting">Authentication buildRunAs(Authentication authentication, Object object,
	List&lt;ConfigAttribute&gt; config);

<span class="hl-keyword">boolean</span> supports(ConfigAttribute attribute);

<span class="hl-keyword">boolean</span> supports(Class clazz);</pre>
<p>The first method returns the <code class="literal">Authentication</code> object that should replace the existing <code class="literal">Authentication</code> object for the duration of the method invocation. If the method returns <code class="literal">null</code>, it indicates no replacement should be made. The second method is used by the <code class="literal">AbstractSecurityInterceptor</code> as part of its startup validation of configuration attributes. The <code class="literal">supports(Class)</code> method is called by a security interceptor implementation to ensure the configured <code class="literal">RunAsManager</code> supports the type of secure object that the security interceptor will present.</p>
<p>One concrete implementation of a <code class="literal">RunAsManager</code> is provided with Spring Security. The <code class="literal">RunAsManagerImpl</code> class returns a replacement <code class="literal">RunAsUserToken</code> if any <code class="literal">ConfigAttribute</code> starts with <code class="literal">RUN_AS_</code>. If any such <code class="literal">ConfigAttribute</code> is found, the replacement <code class="literal">RunAsUserToken</code> will contain the same principal, credentials and granted authorities as the original <code class="literal">Authentication</code> object, along with a new <code class="literal">SimpleGrantedAuthority</code> for each <code class="literal">RUN_AS_</code> <code class="literal">ConfigAttribute</code>. Each new <code class="literal">SimpleGrantedAuthority</code> will be prefixed with <code class="literal">ROLE_</code>, followed by the <code class="literal">RUN_AS</code> <code class="literal">ConfigAttribute</code>. For example, a <code class="literal">RUN_AS_SERVER</code> will result in the replacement <code class="literal">RunAsUserToken</code> containing a <code class="literal">ROLE_RUN_AS_SERVER</code> granted authority.</p>
<p>The replacement <code class="literal">RunAsUserToken</code> is just like any other <code class="literal">Authentication</code> object. It needs to be authenticated by the <code class="literal">AuthenticationManager</code>, probably via delegation to a suitable <code class="literal">AuthenticationProvider</code>. The <code class="literal">RunAsImplAuthenticationProvider</code> performs such authentication. It simply accepts as valid any <code class="literal">RunAsUserToken</code> presented.</p>
<p>To ensure malicious code does not create a <code class="literal">RunAsUserToken</code> and present it for guaranteed acceptance by the <code class="literal">RunAsImplAuthenticationProvider</code>, the hash of a key is stored in all generated tokens. The <code class="literal">RunAsManagerImpl</code> and <code class="literal">RunAsImplAuthenticationProvider</code> is created in the bean context with the same key:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"runAsManager"</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.access.intercept.RunAsManagerImpl"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"key"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"my_run_as_password"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"runAsAuthenticationProvider"</span>
	<span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.security.access.intercept.RunAsImplAuthenticationProvider"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"key"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"my_run_as_password"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>
<p>By using the same key, each <code class="literal">RunAsUserToken</code> can be validated it was created by an approved <code class="literal">RunAsManagerImpl</code>. The <code class="literal">RunAsUserToken</code> is immutable after creation for security reasons</p>
</div>
</div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="x509.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="advanced-topics.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="crypto.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">33.&nbsp;X.509 Authentication&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;35.&nbsp;Spring Security Crypto Module</td></tr></table></div></body></html>